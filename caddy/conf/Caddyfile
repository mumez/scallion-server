{
	order webdav before file_server
}

(verify_jwt) {
	reverse_proxy resty:8080 {
		method GET
		rewrite /verify
		header_up X-Forwarded-Method {method}
		header_up X-Forwarded-Uri {uri}
		header_up Authorization {http.request.header.Authorization}
		@good status 2xx
		handle_response @good {
			request_header -Referer
		}
		handle_response {
			copy_response
		}
	}
}

(cors) {
	header Access-Control-Allow-Origin "{args.0}"
	header Access-Control-Allow-Methods "OPTIONS, LOCK, DELETE, PROPPATCH, COPY, MOVE, UNLOCK, PROPFIND, GET, POST, PUT"
	header Access-Control-Allow-Headers "Authorization, X-Requested-With, X-HTTP-Method-Override, Content-Type, Accept, API, Depth"
	header Vary Origin
	@options {
		method OPTIONS
	}
	respond @options 204
}

(to_dav) {
	@dav {
		path /dav/*
	}
	route @dav {
		root uploads
		import cors "*"
		import verify_jwt
		webdav {
			prefix /dav
		}
	}
}

(to_api) {
	@api {
		# header API true
		path /api/*
	}
	route @api {
		import cors "*"
		import verify_jwt
		uri strip_prefix /api
		reverse_proxy {
			to 192.168.80.128:9088 192.168.80.128:9089
			lb_policy ip_hash
		}
	}
}

:2016 {
	import to_dav
	import to_api
	reverse_proxy localhost:8080
}
